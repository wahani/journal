<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Journal]]></title>
  <link href="http://wahani.github.io/journal/atom.xml" rel="self"/>
  <link href="http://wahani.github.io/journal/"/>
  <updated>2015-01-27T17:55:37+01:00</updated>
  <id>http://wahani.github.io/journal/</id>
  <author>
    <name><![CDATA[Sebastian Warnholz]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[2015-01-26-Notes]]></title>
    <link href="http://wahani.github.io/journal/blog/2015/01/26/Notes"/>
    <updated>2015-01-26T00:00:00+01:00</updated>
    <id>http://wahani.github.io/journal/blog/2015/01/26/Notes</id>
    <content type="html"><![CDATA[<h1 id="how-to-preserve-attributes-of-a-dataframe">How to preserve attributes of a data.frame</h1>

<p>In the following we have two expressions in which the attributes of a data.frame will be lost.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">dat <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="kp">attr</span><span class="p">(</span>dat<span class="p">,</span> <span class="s">&quot;newAttr&quot;</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="m">5</span>

<span class="c1"># works:</span>
<span class="kp">attributes</span><span class="p">(</span>dat<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,])</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## $names
## [1] &quot;x&quot; &quot;y&quot;
## 
## $newAttr
## [1] 5
## 
## $row.names
## [1] 1 2 3 4 5
## 
## $class
## [1] &quot;data.frame&quot;</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># dplyr is evil</span>
<span class="kp">attributes</span><span class="p">(</span>dplyr<span class="o">::</span>filter<span class="p">(</span>dat<span class="p">,</span> x <span class="o">%in%</span> <span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">))</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## $class
## [1] &quot;data.frame&quot;
## 
## $row.names
## [1] 1 2 3 4 5
## 
## $names
## [1] &quot;x&quot; &quot;y&quot;</code></pre></div>

<p>Can we avoid this by using a S4 data.frame?</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>methods<span class="p">)</span>
S4df <span class="o">&lt;-</span> setClass<span class="p">(</span>
    <span class="s">&quot;S4df&quot;</span><span class="p">,</span> 
    contains <span class="o">=</span> <span class="s">&quot;data.frame&quot;</span><span class="p">,</span> 
    slots <span class="o">=</span> <span class="kt">list</span><span class="p">(</span><span class="s">&quot;attributes&quot;</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="p">)</span>
    <span class="p">)</span>

s4dat <span class="o">&lt;-</span> S4df<span class="p">(</span>dat<span class="p">,</span> attributes <span class="o">=</span> <span class="kp">attributes</span><span class="p">(</span>dat<span class="p">))</span>

<span class="kp">attributes</span><span class="p">(</span>dplyr<span class="o">::</span>filter<span class="p">(</span>s4dat<span class="p">,</span> x <span class="o">%in%</span> <span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">))</span> <span class="c1"># does not work...</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): could not convert using R function : as.data.frame</code></pre></div>

<h2 id="okay-functional-programming">Okay, functional programming…</h2>

<div class="highlight"><pre><code class="language-r" data-lang="r">preserve_attributes <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>fun<span class="p">)</span> <span class="p">{</span>
    <span class="kp">force</span><span class="p">(</span>fun<span class="p">)</span>
    <span class="kr">function</span><span class="p">(</span>dat<span class="p">)</span> <span class="p">{</span>
        attOfX <span class="o">&lt;-</span> <span class="kp">attributes</span><span class="p">(</span>dat<span class="p">)</span>
        res <span class="o">&lt;-</span> fun<span class="p">(</span>dat<span class="p">)</span>
        attOfRes <span class="o">&lt;-</span> <span class="kp">attributes</span><span class="p">(</span>res<span class="p">)</span>
        attToPreserve <span class="o">&lt;-</span> <span class="kp">names</span><span class="p">(</span>attOfX<span class="p">)[</span><span class="o">!</span><span class="p">(</span><span class="kp">names</span><span class="p">(</span>attOfX<span class="p">)</span> <span class="o">%in%</span> <span class="kp">names</span><span class="p">(</span>attOfRes<span class="p">))]</span>
        <span class="kp">attributes</span><span class="p">(</span>res<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="kp">attributes</span><span class="p">(</span>res<span class="p">),</span> <span class="kp">attributes</span><span class="p">(</span>dat<span class="p">)[</span>attToPreserve<span class="p">])</span>
        res
    <span class="p">}</span>
<span class="p">}</span>

myFilter <span class="o">&lt;-</span> preserve_attributes<span class="p">(</span>
    functional<span class="o">::</span>CurryL<span class="p">(</span>
        dplyr<span class="o">::</span>filter<span class="p">,</span> <span class="s">&quot;...&quot;</span> <span class="o">=</span> x <span class="o">%in%</span> <span class="m">1</span><span class="o">:</span><span class="m">5</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="kp">attributes</span><span class="p">(</span>myFilter<span class="p">(</span>dat<span class="p">))</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## $class
## [1] &quot;data.frame&quot;
## 
## $row.names
## [1] 1 2 3 4 5
## 
## $names
## [1] &quot;x&quot; &quot;y&quot;
## 
## $newAttr
## [1] 5</code></pre></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015-01-22 Notes]]></title>
    <link href="http://wahani.github.io/journal/blog/2015/01/22/notes"/>
    <updated>2015-01-22T00:00:00+01:00</updated>
    <id>http://wahani.github.io/journal/blog/2015/01/22/notes</id>
    <content type="html"><![CDATA[<p>This might be interesting in combination with <code>lambda.tools::tryn</code>:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">call_with_delay <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>fun<span class="p">,</span> delay<span class="p">)</span> <span class="p">{</span>
    <span class="kp">force</span><span class="p">(</span>delay<span class="p">)</span>
    <span class="kr">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="kp">Sys.sleep</span><span class="p">(</span>delay<span class="p">)</span>
        fun<span class="p">(</span><span class="kc">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>What if I have a function which needs to be applied to each element and later I want to vectorize it.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">lapply_wrapper <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>fun<span class="p">,</span> red_fun <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> x<span class="p">)</span> <span class="p">{</span>
    <span class="kp">force</span><span class="p">(</span>fun<span class="p">)</span>
    <span class="kp">force</span><span class="p">(</span>red_fun<span class="p">)</span>
    <span class="kr">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
        mc <span class="o">&lt;-</span> <span class="kp">match.call</span><span class="p">(</span>fun<span class="p">)</span>
        mc<span class="p">[[</span><span class="m">1</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="kp">quote</span><span class="p">(</span><span class="kp">lapply</span><span class="p">)</span>
        <span class="kp">names</span><span class="p">(</span>mc<span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;X&quot;</span>
        funPos <span class="o">&lt;-</span> <span class="kp">length</span><span class="p">(</span>mc<span class="p">)</span> <span class="o">+</span> <span class="m">1</span>
        mc<span class="p">[[</span>funPos<span class="p">]]</span> <span class="o">&lt;-</span> <span class="kp">quote</span><span class="p">(</span>fun<span class="p">)</span>
        <span class="kp">names</span><span class="p">(</span>mc<span class="p">)[</span>funPos<span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;FUN&quot;</span>
        red_fun<span class="p">(</span><span class="kp">eval</span><span class="p">(</span>mc<span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>And a test:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">vec_mean <span class="o">&lt;-</span> lapply_wrapper<span class="p">(</span><span class="kp">mean</span><span class="p">,</span> <span class="kp">unlist</span><span class="p">)</span>
vec_mean<span class="p">(</span><span class="kt">list</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span> <span class="m">2</span><span class="o">:</span><span class="m">10</span><span class="p">))</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## [1] 3 6</code></pre></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup Jekyll Octopress and Knitr for Workflow]]></title>
    <link href="http://wahani.github.io/journal/blog/2015/01/13/Setup-Jekyll-Octopress-and-knitr-for-workflow"/>
    <updated>2015-01-13T00:00:00+01:00</updated>
    <id>http://wahani.github.io/journal/blog/2015/01/13/Setup-Jekyll-Octopress-and-knitr-for-workflow</id>
    <content type="html"><![CDATA[<p>Hello!</p>

<h2 id="requirements">Requirements</h2>

<div class="highlight"><pre><code class="language-r" data-lang="r">install.packages<span class="p">(</span>
  <span class="kt">c</span><span class="p">(</span><span class="s">&#39;servr&#39;</span><span class="p">,</span> <span class="s">&#39;knitr&#39;</span><span class="p">),</span>
  type <span class="o">=</span> <span class="s">&#39;source&#39;</span><span class="p">,</span>
  repos <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#39;http://yihui.name/xran&#39;</span><span class="p">,</span> <span class="s">&#39;http://cran.rstudio.com&#39;</span><span class="p">)</span>
<span class="p">)</span></code></pre></div>

<h2 id="in-rstudio">In RStudio</h2>

<div class="highlight"><pre><code class="language-r" data-lang="r">servr<span class="o">::</span>jekyll<span class="p">(</span>input <span class="o">=</span> <span class="s">&quot;_rmd&quot;</span><span class="p">,</span> output <span class="o">=</span> <span class="s">&quot;source/_posts&quot;</span><span class="p">)</span></code></pre></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Functional Programming With lambda.r]]></title>
    <link href="http://wahani.github.io/journal/blog/2014/06/15/Functional-Programming-with-lambdar"/>
    <updated>2014-06-15T00:00:00+02:00</updated>
    <id>http://wahani.github.io/journal/blog/2014/06/15/Functional-Programming-with-lambdar</id>
    <content type="html"><![CDATA[<p>My first post was on <a href="http://wahani.github.io/journal/Introducing-S4-Methods/">S4-methods</a> and how I could add new features to a function without changing it – using function dispatch in S4. This works out fine, but is not optimal for me. </p>

<ul>
  <li>The function <code>setMethod</code> introduces code which is dificult to read</li>
  <li>The dispatch uses classes not attributes or different conditions for dispatch</li>
  <li>I am not trained to use object orientation as a programming style (I am not at all trained as a programmer) and after using it in a project I think if I want to get started with object orientation maybe I should not use a functional language to begin with</li>
  <li>I would never use S4 outside package delelopment</li>
  <li>And S4 is not playing nice with roxygen2, it took me hours to adjust my workflow</li>
</ul>

<p>So I wanted to get back to the functional programming techniques available in R. Here <a href="http://cran.r-project.org/web/packages/lambda.r/index.html">lambda.r</a> seems to be a nice addition to what R already offers. Especially the capability of dispatching functions. So here is an example.
<!--more-->
## Example function</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>magrittr<span class="p">)</span>
dat <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> rnorm<span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="kp">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> length.out<span class="o">=</span><span class="m">10</span><span class="p">)),</span> group <span class="o">=</span> <span class="kp">gl</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">5</span><span class="p">))</span>

applyFun <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>dat<span class="p">,</span> var<span class="p">,</span> fun<span class="p">,</span> <span class="kp">by</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
  <span class="kp">split</span><span class="p">(</span>dat<span class="p">,</span> dat<span class="p">[</span><span class="kp">by</span><span class="p">])</span> <span class="o">%&gt;%</span> <span class="kp">lapply</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span>df<span class="p">)</span> <span class="p">{</span>
    df<span class="p">[[</span>var<span class="p">]]</span> <span class="o">&lt;-</span> fun<span class="p">(</span>df<span class="p">[[</span>var<span class="p">]],</span> <span class="kc">...</span><span class="p">)</span>
    df
    <span class="p">})</span> <span class="o">%&gt;%</span> <span class="kp">do.call</span><span class="p">(</span>what<span class="o">=</span><span class="kp">rbind</span><span class="p">)</span>
  <span class="p">}</span>

applyFun<span class="p">(</span>dat<span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="kp">mean</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##             x group
## 1.1  1.966370     1
## 1.2  1.966370     1
## 1.3  1.966370     1
## 1.4  1.966370     1
## 1.5  1.966370     1
## 2.6  4.230699     2
## 2.7  4.230699     2
## 2.8  4.230699     2
## 2.9  4.230699     2
## 2.10 4.230699     2</code></pre></div>

<p>The function <code>applyFun</code> will apply <code>fun</code> on a subset denoted by <code>group</code> and the variable <code>var</code>. This may be usefull if you do transformations on single variables which are different in each group, or you do not want your data collapsed, i.e. preserve the original number of rows. <code>group</code> for example can be a chracter with <code>length &gt; 1</code>, I can plug in any function wich will return a scalar or a vector with the length of the input. However, it will only work on a single variable in the data, so <code>var</code> schould have length 1. I could try something with <code>[</code> instead of <code>[[</code> for subsetting but then the requirements for <code>fun</code> will change and I do want to preserve the behaviour of <code>applyFun</code>.</p>

<h2 id="how-can-lambdar-help">How can lambda.r help?</h2>

<p>There are different possibilities to allow vectors in the argument <code>var</code> of <code>applyFun</code>:     <br />
* rewrite <code>applyFun</code>
* write a new function calling <code>applyFun</code>
* write a function called <code>applyFun</code> calling the version of <code>applyFun</code> where <code>var</code> is a scalar: use the function dispatch introduced in lambda.r
* And of course many more…</p>

<p>I don’t like the first choice, I have a running collection of functions and they like each other so I like the function the way it is. The second would be okay, but I am not very creative in comming up with new function names; and remembering them is even harder. Let’s see how the third option is working out:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>lambda.r<span class="p">)</span>
<span class="kp">rm</span><span class="p">(</span>applyFun<span class="p">)</span>

<span class="c1"># Version of lambda.r if length(var) == 1</span>
applyFun<span class="p">(</span>dat<span class="p">,</span> var<span class="p">,</span> fun<span class="p">,</span> <span class="kp">by</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="o">%when%</span> <span class="p">{</span>
  <span class="kp">length</span><span class="p">(</span>var<span class="p">)</span> <span class="o">==</span> <span class="m">1</span>
<span class="p">}</span> <span class="o">%as%</span> <span class="p">{</span>
  <span class="kp">split</span><span class="p">(</span>dat<span class="p">,</span> dat<span class="p">[</span><span class="kp">by</span><span class="p">])</span> <span class="o">%&gt;%</span> <span class="kp">lapply</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span>df<span class="p">)</span> <span class="p">{</span>
    df<span class="p">[[</span>var<span class="p">]]</span> <span class="o">&lt;-</span> fun<span class="p">(</span>df<span class="p">[[</span>var<span class="p">]],</span> <span class="kc">...</span><span class="p">)</span>
    df
  <span class="p">})</span> <span class="o">%&gt;%</span> <span class="kp">do.call</span><span class="p">(</span>what<span class="o">=</span><span class="kp">rbind</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Version of lambda.r if length(var) != 1</span>
applyFun<span class="p">(</span>dat<span class="p">,</span> var<span class="p">,</span> fun<span class="p">,</span> <span class="kp">by</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="o">%as%</span> <span class="p">{</span>
  <span class="kr">for</span> <span class="p">(</span>varName <span class="kr">in</span> var<span class="p">)</span> <span class="p">{</span>
    dat <span class="o">&lt;-</span> applyFun<span class="p">(</span>dat<span class="p">,</span> varName<span class="p">,</span> fun<span class="p">,</span> <span class="kp">by</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span>
  <span class="p">}</span>
  dat
<span class="p">}</span>

applyFun<span class="p">(</span>dat<span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="kp">mean</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##             x group
## 1.1  1.966370     1
## 1.2  1.966370     1
## 1.3  1.966370     1
## 1.4  1.966370     1
## 1.5  1.966370     1
## 2.6  4.230699     2
## 2.7  4.230699     2
## 2.8  4.230699     2
## 2.9  4.230699     2
## 2.10 4.230699     2</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r">dat<span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> rnorm<span class="p">(</span><span class="m">10</span><span class="p">)</span>
applyFun<span class="p">(</span>dat<span class="p">,</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">),</span> <span class="kp">mean</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##               x group           y
## 1.1.1  1.966370     1 -0.23740634
## 1.1.2  1.966370     1 -0.23740634
## 1.1.3  1.966370     1 -0.23740634
## 1.1.4  1.966370     1 -0.23740634
## 1.1.5  1.966370     1 -0.23740634
## 2.2.6  4.230699     2 -0.05986417
## 2.2.7  4.230699     2 -0.05986417
## 2.2.8  4.230699     2 -0.05986417
## 2.2.9  4.230699     2 -0.05986417
## 2.2.10 4.230699     2 -0.05986417</code></pre></div>

<p>With <code>%when%</code> I introduce a condition, or multiple conditions, which needs to evaluate to <code>TRUE</code>. If it does the function body introduced by <code>%as%</code> is evaluated exactly like before. So I am generating a couple of more lines, but I can reuse the function body of the original <code>applyFun</code> definition. The second definition of <code>applyFun</code> is what will be called if <code>length(var) != 1</code>. So something like the else statement in a if-else clause. Like in a if-else control structure the order is important. So either I control access using a second <code>%when%</code> or the definition needs to be after the ‘<code>length(var) == 1</code>’ version, which I did here.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saeSim: Simulation Tools in Small Area Estimation]]></title>
    <link href="http://wahani.github.io/journal/blog/2014/06/03/Simulations-in-Small-Area-Estimation"/>
    <updated>2014-06-03T00:00:00+02:00</updated>
    <id>http://wahani.github.io/journal/blog/2014/06/03/Simulations-in-Small-Area-Estimation</id>
    <content type="html"><![CDATA[<p>In this post I want to introduce the package <a href="http://wahani.github.io/journal/saeSim">saeSim</a>. The package improved my set-up of design-based and model-based simulation scenarios in the context of Small Area Estimation. It introduces components with which the flow of the simulation is framed and supports a unified structure and interface between each step.</p>

<!--more-->

<h2 id="general-idea-and-workflow">General idea and workflow</h2>
<p>As I was writing my scripts for simulation I typically ended up using loop structures every second line. Every time I wanted to add or change something, I appended new lines to the script which then needed to iterate over my data. Consider a simple task: Predict a population mean and compare the bias of a linear model and sample average. Repeat this 100 times. The task is clear, simulate 100 populations, compute the mean in each population, draw a sample from each population apply the two models on the samples and estimate the population mean.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>

<span class="c1"># Generate data</span>
dataList <span class="o">&lt;-</span> <span class="kp">replicate</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="p">{</span>
  dat <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> rnorm<span class="p">(</span><span class="m">100</span><span class="p">),</span> e <span class="o">=</span> rnorm<span class="p">(</span><span class="m">100</span><span class="p">))</span>
  dat<span class="o">$</span>y <span class="o">&lt;-</span> <span class="m">100</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> dat<span class="o">$</span>x <span class="o">+</span> dat<span class="o">$</span>e
  dat
<span class="p">},</span> simplify <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>

<span class="c1"># population mean</span>
dataList <span class="o">&lt;-</span> <span class="kp">lapply</span><span class="p">(</span>dataList<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>dat<span class="p">)</span> <span class="p">{</span>
  dat<span class="o">$</span>popMean <span class="o">&lt;-</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>y<span class="p">)</span>
  dat
<span class="p">})</span>

<span class="c1"># Draw a sample</span>
dataList <span class="o">&lt;-</span> <span class="kp">lapply</span><span class="p">(</span>dataList<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>dat<span class="p">)</span> dat<span class="p">[</span><span class="kp">sample.int</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">20</span><span class="p">),</span> <span class="p">])</span>

<span class="c1"># Apply model and make prediction</span>
dataList <span class="o">&lt;-</span> <span class="kp">lapply</span><span class="p">(</span>dataList<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>dat<span class="p">)</span> <span class="p">{</span>
  fancyModel <span class="o">&lt;-</span> lm<span class="p">(</span>y <span class="o">~</span> x<span class="p">,</span> data <span class="o">=</span> dat<span class="p">)</span>
  out <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>
    lm <span class="o">=</span> predict<span class="p">(</span>fancyModel<span class="p">,</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>x<span class="p">))),</span>
    mean <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>y<span class="p">),</span>
    popMean <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>popMean<span class="p">)</span>
    <span class="p">)</span>
  out
<span class="p">})</span>

dat <span class="o">&lt;-</span> <span class="kp">do.call</span><span class="p">(</span><span class="kp">rbind</span><span class="p">,</span> dataList<span class="p">)</span>
dat<span class="o">$</span>biasLm <span class="o">&lt;-</span> dat<span class="o">$</span>lm <span class="o">-</span> dat<span class="o">$</span>popMean
dat<span class="o">$</span>biasMean <span class="o">&lt;-</span> dat<span class="o">$</span>mean <span class="o">-</span> dat<span class="o">$</span>popMean

datEval <span class="o">&lt;-</span> melt<span class="p">(</span>dat<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;biasLm&quot;</span><span class="p">,</span> <span class="s">&quot;biasMean&quot;</span><span class="p">)])</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## No id variables; using all as measure variables</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r">boxplot<span class="p">(</span>value <span class="o">~</span> variable<span class="p">,</span> data <span class="o">=</span> datEval<span class="p">,</span> horizontal<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span></code></pre></div>

<p><img src="http://wahani.github.io/journal/images/images/2014-06-03-Simulations-in-Small-Area-Estimation/unnamed-chunk-1-1.png" title="center" alt="center" width="100%" /></p>

<p>Imagine this style of writing with more complex data and models and hundreds or thousands of lines of code. Reproducing yourself is a mess, let alone find bugs, mistakes, etc. Another issue is that a lot of effort is needed to parallelize the computation. I would need to replace every looping structure with a parallel version. And furthermore the real task is shadowed by all kinds of unnecessary control structures. The idea to overcome this was to write one function which would do the data generation and computation on that data. That would lead only to one loop and to a potentially long function for simulation – although it is not a problem to split the task step-wise into smaller functions which would be called in the ‘main’ simulation function. In the end this is what I tried with saeSim. I identified the repeating steps and built a framework so I can easily set-up simulations without thinking about the structure and more about the statistical problem.</p>

<h2 id="a-simsetup">A sim_setup</h2>
<p>In all I have 6 steps I can part my simulation into. </p>

<ul>
  <li>data generation: <code>sim_gen()</code></li>
  <li>computing on the population: <code>sim_calc(., level = "population")</code></li>
  <li>drawing samples: <code>sim_sample()</code></li>
  <li>computing on the sample: <code>sim_calc(., level = "sample")</code></li>
  <li>aggregating the data (area level information): <code>sim_agg()</code></li>
  <li>finally computing on the aggregates: <code>sim_calc(., level = "agg")</code></li>
</ul>

<p>The purpose of these functions is simply to control the flow of the simulation and they all take a function as argument. In other words all of these functions control <em>when</em> a function is called – you can decide which function that will be. Let’s see how things add up for a simple data generation scenario:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># devtools::install_github(&quot;wahani/saeSim&quot;)</span>
<span class="kn">library</span><span class="p">(</span>saeSim<span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## Loading required package: methods
## Documentation is available at wahani.github.io/saeSim</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Generating a population with 100 domains and 100 units in each domain:</span>
setup <span class="o">&lt;-</span> base_id<span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># Variable x and error component e</span>
  sim_gen_x<span class="p">(</span>sd <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span>
  sim_gen_e<span class="p">(</span>sd <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span>
  sim_resp_eq<span class="p">(</span>y <span class="o">=</span> <span class="m">100</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> x <span class="o">+</span> e<span class="p">)</span></code></pre></div>

<p>To inspect <code>setup</code> I have a <code>plot</code>, <code>autoplot</code>, <code>summary</code> and <code>show</code> method.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">setup</code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##   idD idU           x           e         y
## 1   1   1  0.37848715 -0.56426537 100.19271
## 2   1   2 -0.03322072  0.03155332  99.96511
## 3   1   3  0.69302346 -0.91341329 100.47263
## 4   1   4  0.70192788 -1.14242630 100.26143
## 5   1   5  0.88992447 -0.44572650 101.33412
## 6   1   6 -0.72537724  1.60834101 100.15759</code></pre></div>

<p>Note that the response ‘y’ will always be constructed automatically. To visualize the data, the plot method will always try to find ‘y’ and plot it against the first variable found.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">plot<span class="p">(</span>setup<span class="p">)</span></code></pre></div>

<p><img src="http://wahani.github.io/journal/images/images/2014-06-03-Simulations-in-Small-Area-Estimation/unnamed-chunk-4-1.png" title="center" alt="center" width="100%" /></p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># What happens if I add contamination to the error:</span>
plot<span class="p">(</span>setup <span class="o">%&gt;%</span> sim_gen_ec<span class="p">())</span></code></pre></div>

<p><img src="http://wahani.github.io/journal/images/images/2014-06-03-Simulations-in-Small-Area-Estimation/unnamed-chunk-4-2.png" title="center" alt="center" width="100%" /></p>

<p>In contrast the <code>autoplot</code> function will use ggplot2 and will plot a two dimensional density estimate, very much like <code>smoothScatter</code>.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">autoplot<span class="p">(</span>setup<span class="p">)</span></code></pre></div>

<p><img src="http://wahani.github.io/journal/images/images/2014-06-03-Simulations-in-Small-Area-Estimation/unnamed-chunk-5-1.png" title="center" alt="center" width="100%" /></p>

<h2 id="back-to-the-introductory-example">Back to the introductory example</h2>
<p>So how does my scripting change using <code>saeSim</code>. I have some data generation interfaces which are a bit clumsy in this setting, they make my coding clearer in more complex scenarios. My simulation components are connected using the <code>%&amp;%</code> operator. So even complex tasks can be split into several lines to maintain readability. The set-up is separated from the actual repetition, which allows to construct more complex designs and test them easily as I add new steps and components to the scenario.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Population with 1 domain and 100 units</span>
setup <span class="o">&lt;-</span> base_id<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># y = 100 + 2*x + e</span>
  sim_gen<span class="p">(</span>gen_norm<span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  sim_gen<span class="p">(</span>gen_norm<span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  sim_resp_eq<span class="p">(</span>y <span class="o">=</span> <span class="m">100</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> x <span class="o">+</span> e<span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># Keeping the mean of y</span>
  sim_comp_popMean<span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="c1"># Drawing a simple random sample with n = 20</span>
  sim_sample<span class="p">(</span>sample_number<span class="p">(</span><span class="m">20</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="c1"># Computing the estimated parameters</span>
  sim_comp_sample<span class="p">(</span><span class="kr">function</span><span class="p">(</span>dat<span class="p">)</span> <span class="p">{</span>
    fancyModel <span class="o">&lt;-</span> lm<span class="p">(</span>y <span class="o">~</span> x<span class="p">,</span> data <span class="o">=</span> dat<span class="p">)</span>
    out <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>
      lm <span class="o">=</span> predict<span class="p">(</span>fancyModel<span class="p">,</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>x<span class="p">))),</span>
      mean <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>y<span class="p">),</span>
      popMean <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>dat<span class="o">$</span>popMean<span class="p">)</span>
      <span class="p">)</span>
    out
    <span class="p">})</span>

setup</code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##         lm     mean  popMean
## 1 100.5592 100.5592 99.80724</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Running the simulation</span>
res <span class="o">&lt;-</span> sim<span class="p">(</span>setup<span class="p">,</span> R <span class="o">=</span> <span class="m">100</span><span class="p">)</span>

<span class="c1"># Combining results as before:</span>
dat <span class="o">&lt;-</span> <span class="kp">do.call</span><span class="p">(</span><span class="kp">rbind</span><span class="p">,</span> res<span class="p">)</span>
dat<span class="o">$</span>biasLm <span class="o">&lt;-</span> dat<span class="o">$</span>lm <span class="o">-</span> dat<span class="o">$</span>popMean
dat<span class="o">$</span>biasMean <span class="o">&lt;-</span> dat<span class="o">$</span>mean <span class="o">-</span> dat<span class="o">$</span>popMean
datEval <span class="o">&lt;-</span> melt<span class="p">(</span>dat<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;biasLm&quot;</span><span class="p">,</span> <span class="s">&quot;biasMean&quot;</span><span class="p">)])</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## No id variables; using all as measure variables</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r">boxplot<span class="p">(</span>value <span class="o">~</span> variable<span class="p">,</span> data <span class="o">=</span> datEval<span class="p">,</span> horizontal<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span></code></pre></div>

<p><img src="http://wahani.github.io/journal/images/images/2014-06-03-Simulations-in-Small-Area-Estimation/unnamed-chunk-6-1.png" title="center" alt="center" width="100%" /></p>

<h2 id="how-to-get-started">How to get started</h2>
<p>If you have come this far and in the case you are still interested in what this is about, go to the <a href="http://wahani.github.io/journal/saeSim">homepage of saeSim</a>, install the package, checkout the vignette, add comments here or on <a href="https://github.com/wahani/saeSim">GitHub</a>…</p>
]]></content>
  </entry>
  
</feed>
